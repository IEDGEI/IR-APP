<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>IRì„¼í„° - íŒŒì¼ ì—…ë¡œë“œ ë° ì°¨íŠ¸ ì‹œê°í™”</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='chartstyle.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    #chart-container {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 9999;
      overflow-y: auto;
      padding: 20px;
    }
    #chart-container canvas {
      background-color: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 2rem auto 1rem;
      display: block;
    }
    #chart-container .download-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 2rem;
    }
    #chart-container .download-buttons button {
      padding: 8px 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #chart-container .top-buttons {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    #chart-container .top-buttons.hidden { display: none; }
    #chart-container .top-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #chart-container .side-wrapper {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      display: none;
      flex-direction: row;
      z-index: 999;
    }
    #chart-container .side-wrapper.active { display: flex; }
    #chart-container .button-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      background-color: #e0e0e0;
    }
    #chart-container .button-panel button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #chart-container .side-container {
      width: 20vw;
      height: 100%;
      background-color: #f9f9f9;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: relative;
      overflow-y: auto;
    }
    #chart-container .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    #chart-container label {
      font-weight: bold;
      margin: 10px 0 5px;
    }
    #chart-container select,
    #chart-container input[type="file"] {
      font-size: 1rem;
      padding: 0.4rem 0.6rem;
      margin-bottom: 1rem;
      width: 100%;
    }
    #open-chart-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
    }
    #close-chart-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- ğŸ”˜ ì°¨íŠ¸ ì—´ê¸° ë²„íŠ¼ -->
  <button id="open-chart-btn" onclick="openChartContainer()">ğŸ“Š ì°¨íŠ¸ ë³´ê¸°</button>

  <!-- âœ… ë©”ì¸ íŒŒì¼ ì—…ë¡œë“œ + ê²€ìƒ‰ -->
  <h2>ğŸ“ ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ</h2>
  <form id="upload-form-main">
    <input type="file" id="file-input-main" name="files[]" multiple />
    <button type="submit">ì—…ë¡œë“œ</button>
  </form>
  <div id="upload-result" style="margin-top: 10px;"></div>

  <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" oninput="searchFiles()" />
  <h3>ğŸ“‚ ì €ì¥ëœ íŒŒì¼ ëª©ë¡</h3>
  <ul id="file-list-main"></ul>

  <!-- ğŸ“¦ ì°¨íŠ¸ ì „ì²´í™”ë©´ ì»¨í…Œì´ë„ˆ -->
  <div id="chart-container">
    <button id="close-chart-btn" onclick="closeChartContainer()">Ã—</button>

    <div class="top-buttons" id="topButtons">
      <button onclick="openContainer('container1')">ì„¤ì •</button>
      <button onclick="openContainer('container2')">ì—…ë¡œë“œ</button>
    </div>

    <!-- ì„¤ì • íŒ¨ë„ -->
    <div class="side-wrapper" id="container1">
      <div class="button-panel">
        <button onclick="openContainer('container1')">ì„¤ì •</button>
        <button onclick="openContainer('container2')">ì—…ë¡œë“œ</button>
      </div>
      <div class="side-container">
        <button class="close-btn" onclick="closeContainers()">Ã—</button>
        <h3>ğŸ“Œ ì°¨íŠ¸ ì„¤ì •</h3>

        <label for="x-col">Xì¶• ì»¬ëŸ¼</label>
        <select id="x-col"></select>

        <label for="y-col">Yê°’ ì»¬ëŸ¼</label>
        <select id="y-col"></select>

        <label for="legend-col">ë²”ë¡€ ì»¬ëŸ¼</label>
        <select id="legend-col"><option value="">ì„ íƒ ì•ˆí•¨</option></select>

        <label for="chart-type">ì°¨íŠ¸ ìœ í˜•</label>
        <select id="chart-type">
          <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
          <option value="stacked-bar">ìŠ¤íƒí˜• ë§‰ëŒ€</option>
          <option value="line">ì„  ê·¸ë˜í”„</option>
        </select>
      </div>
    </div>
    <!-- ì—…ë¡œë“œ íŒ¨ë„ -->
    <div class="side-wrapper" id="container2">
      <div class="button-panel">
        <button onclick="openContainer('container1')">ì„¤ì •</button>
        <button onclick="openContainer('container2')">ì—…ë¡œë“œ</button>
      </div>
      <div class="side-container">
        <button class="close-btn" onclick="closeContainers()">Ã—</button>
        <h3>ğŸ“¤ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>

        <form id="upload-form-side">
          <input type="file" id="file-input-side" accept=".xlsx,.xls,.csv" multiple />
          <button type="submit">ì°¨íŠ¸ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </form>

        <div id="result" style="margin-top:10px;"></div>
        <div id="file-list-side" style="margin-top:10px;"></div>
      </div>
    </div>

    <h2>ğŸ“Š ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h2>
    <canvas id="myChart" width="700" height="400"></canvas>

    <div class="download-buttons">
      <button onclick="downloadChart()">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadPdf()">PDF ì €ì¥</button>
    </div>
  </div> <!-- #chart-container ë‹«í˜ -->

  <!-- JavaScript ì‹œì‘ -->
  <script>
    function openChartContainer() {
      document.getElementById('chart-container').style.display = 'block';
      document.getElementById('open-chart-btn').style.display = 'none';
    }

    function closeChartContainer() {
      document.getElementById('chart-container').style.display = 'none';
      document.getElementById('open-chart-btn').style.display = 'inline-block';
    }

    function openContainer(id) {
      document.getElementById('topButtons').classList.add('hidden');
      document.getElementById('container1').classList.remove('active');
      document.getElementById('container2').classList.remove('active');
      document.getElementById(id).classList.add('active');
    }

    function closeContainers() {
      document.getElementById('container1').classList.remove('active');
      document.getElementById('container2').classList.remove('active');
      document.getElementById('topButtons').classList.remove('hidden');
    }
    async function loadFileList() {
      const res = await fetch('/files');
      const data = await res.json();
      const listEl = document.getElementById('file-list-main');
      listEl.innerHTML = '';
      data.files.forEach(file => {
        const encoded = encodeURIComponent(file);
        const li = document.createElement('li');
        li.innerHTML = `
          ${file}
          <a href="/static/uploads/${encoded}" target="_blank">[ì—´ê¸°]</a>
          <button onclick="deleteFile('${file}')">âŒ ì‚­ì œ</button>
          <button onclick="uploadExcelWithOneFile('${file}', '/static/uploads/${encoded}')">ğŸ“¤ ì—‘ì…€ë¡œ ì—…ë¡œë“œ</button>
        `;
        listEl.appendChild(li);
      });
    }

    async function deleteFile(filename) {
      if (!confirm(`'${filename}' íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      const res = await fetch('/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename })
      });
      const result = await res.json();
      if (result.success) {
        alert(`ì‚­ì œ ì™„ë£Œ`);
        loadFileList();
      } else {
        alert('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    async function uploadExcelWithOneFile(filename, fileUrl) {
      const data = [{ íŒŒì¼ëª…: filename, ë‹¤ìš´ë¡œë“œë§í¬: fileUrl }];
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "íŒŒì¼ì •ë³´");

      const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });

      const formData = new FormData();
      const excelName = `íŒŒì¼_${filename.replace(/\.[^/.]+$/, '')}.xlsx`;
      formData.append('files[]', new File([blob], excelName));

      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        alert(`âœ… ${excelName} ì—…ë¡œë“œ ì™„ë£Œ`);
        loadFileList();
      } else {
        alert(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨`);
      }
    }

    document.getElementById('upload-form-main').addEventListener('submit', async function (e) {
      e.preventDefault();
      const files = document.getElementById('file-input-main').files;
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files[]', files[i]);
      }
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        document.getElementById('upload-result').innerText = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${result.files.join(', ')}`;
        loadFileList();
      }
    });

    function searchFiles() {
      const keyword = document.getElementById('search-input').value.trim();
      if (keyword === '') return loadFileList();

      fetch('/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword })
      })
        .then(res => res.json())
        .then(data => {
          const listEl = document.getElementById('file-list-main');
          listEl.innerHTML = '';
          data.matches.forEach(fileObj => {
            const encoded = encodeURIComponent(fileObj.filename);
            const li = document.createElement('li');
            li.innerHTML = `
              ${fileObj.filename}
              <a href="/static/uploads/${encoded}" target="_blank">[ì—´ê¸°]</a>
              <button onclick="deleteFile('${fileObj.filename}')">âŒ ì‚­ì œ</button>
              <button onclick="uploadExcelWithOneFile('${fileObj.filename}', '/static/uploads/${encoded}')">ğŸ“¤ ì—‘ì…€ë¡œ ì—…ë¡œë“œ</button>
            `;
            if (fileObj.matched) {
              li.style.backgroundColor = '#fffbcc';
              li.style.fontWeight = 'bold';
            }
            listEl.appendChild(li);
          });
        });
    }

    // ì°¨íŠ¸ ê´€ë ¨ ì„¤ì •
    const xSelect = document.getElementById("x-col");
    const ySelect = document.getElementById("y-col");
    const legendSelect = document.getElementById("legend-col");
    const chartTypeSelect = document.getElementById("chart-type");
    const chartCanvas = document.getElementById("myChart");
    let jsonData = [];
    let myChart;

    [xSelect, ySelect, legendSelect, chartTypeSelect].forEach(sel => {
      sel.addEventListener("change", drawChart);
    });

    function drawChart() {
      if (!jsonData.length) return;
      const xCol = xSelect.value;
      const yCol = ySelect.value;
      const legendCol = legendSelect.value;
      const chartType = chartTypeSelect.value;
      const isStacked = chartType === "stacked-bar";
      const isLegendUsed = legendCol !== "";

      const xSet = new Set();
      const grouped = {};
      const colors = Array.from({ length: 100 }, (_, i) => `hsl(${i * 30 % 360}, 70%, 60%)`);

      if (isLegendUsed) {
        const legendSet = new Set();
        jsonData.forEach(row => {
          const x = row[xCol];
          const legend = row[legendCol];
          const y = Number(row[yCol]) || 0;
          xSet.add(x); legendSet.add(legend);
          if (!grouped[legend]) grouped[legend] = {};
          grouped[legend][x] = (grouped[legend][x] || 0) + y;
        });

        const xLabels = Array.from(xSet);
        const legends = Array.from(legendSet);
        const datasets = legends.map((legend, i) => ({
          label: legend,
          data: xLabels.map(x => grouped[legend][x] || 0),
          backgroundColor: colors[i % colors.length],
          borderColor: colors[i % colors.length],
          fill: chartType !== 'line',
          ...(isStacked && { stack: 'stack1' })
        }));

        renderChart(chartType === 'stacked-bar' ? 'bar' : chartType, xLabels, datasets, isStacked);
      } else {
        jsonData.forEach(row => {
          const x = row[xCol];
          const y = Number(row[yCol]) || 0;
          xSet.add(x); grouped[x] = (grouped[x] || 0) + y;
        });

        const xLabels = Array.from(xSet);
        const dataset = [{
          label: yCol,
          data: xLabels.map(x => grouped[x]),
          backgroundColor: 'skyblue',
          borderColor: 'skyblue',
          fill: chartType !== 'line'
        }];

        renderChart(chartType === 'stacked-bar' ? 'bar' : chartType, xLabels, dataset, false);
      }
    }

    function renderChart(type, labels, datasets, stacked) {
      if (myChart) myChart.destroy();
      const ctx = chartCanvas.getContext("2d");
      myChart = new Chart(ctx, {
        type,
        data: { labels, datasets },
        options: {
          responsive: false,
          plugins: {
            title: { display: true, text: "ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸°" },
            legend: { display: true, position: 'top' }
          },
          scales: {
            x: {
              stacked, offset: true,
              categoryPercentage: stacked ? 0.8 : 0.6,
              barPercentage: stacked ? 1.0 : 0.9,
              ticks: { align: 'center' }
            },
            y: { stacked, beginAtZero: true }
          }
        }
      });
    }

    function downloadChart() {
      const a = document.createElement("a");
      a.href = chartCanvas.toDataURL("image/png");
      a.download = "chart.png";
      a.click();
    }

    async function downloadPdf() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const imgData = chartCanvas.toDataURL("image/png");
      pdf.addImage(imgData, 'PNG', 10, 10, 180, 100);
      pdf.save("chart.pdf");
    }

    window.onload = loadFileList;
  </script>
</body>
</html>
